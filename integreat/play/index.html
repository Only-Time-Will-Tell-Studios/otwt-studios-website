<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integreat! - Calculus Roguelike</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #020617;
            color: #e2e8f0;
            overflow: hidden;
            user-select: none;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
        }

        #app-scaler {
            width: 1280px;
            height: 800px;
            position: relative;
            transform-origin: center center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            background-color: #0f172a;
            overflow: hidden;
        }

        /* Card Interactions */
        .card {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s;
        }
        .card:not(.disabled):hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            z-index: 50;
        }
        .card.dragging {
            opacity: 0.5;
            transform: scale(0.9);
        }

        /* Slot Interactions */
        .slot { transition: all 0.2s; }
        .slot.drag-over {
            background-color: rgba(56, 189, 248, 0.2);
            border-color: #38bdf8;
            transform: scale(1.05);
        }

        /* VFX */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: rise 1.5s ease-out forwards;
            z-index: 100;
        }
        @keyframes rise {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.2); opacity: 0; }
        }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* CRT Scanline Effect */
        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 50;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Tutorial Overlay Animation */
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="app-scaler" class="crt flex flex-col">
        
        <!-- TOP HUD -->
        <div class="h-24 flex justify-between items-center bg-slate-900/90 px-8 border-b border-slate-700 relative z-20 shadow-lg">
            <div class="flex flex-col">
                <h1 class="text-3xl font-bold text-sky-400 tracking-tighter drop-shadow-lg leading-none">INTEGREAT!</h1>
                <div class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">The Calculus Roguelike</div>
            </div>
            
            <div class="flex gap-8 text-sm items-center">
                <!-- Round Info -->
                <div class="flex flex-col items-center min-w-[80px]">
                    <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Round</div>
                    <div class="flex gap-1 text-2xl font-bold text-white">
                        <span id="round-display">1</span> 
                        <span>
                            <div class="text-[8px] text-slate-500 uppercase tracking-widest font-bold" style="text-align: center; line-height: normal; transform: translateY(2px);">Level</div>
                            <div class="text-sm text-slate-500" style="text-align: center;" id="level-display">1/5</div>
                        </span>
                    </div>
                </div>

                <!-- Score -->
                <div class="flex flex-col items-center min-w-[100px] bg-slate-800/50 p-2 rounded border border-slate-700">
                    <div class="text-[10px] text-emerald-400 uppercase tracking-widest font-bold">Round Score</div>
                    <div id="score-display" class="text-2xl font-bold text-emerald-300">0</div>
                </div>

                <!-- Multiplier -->
                <div class="flex flex-col items-center min-w-[80px]">
                    <div class="text-[10px] text-amber-400 uppercase tracking-widest font-bold">Mult</div>
                    <div class="text-2xl font-bold text-amber-300">x<span id="mult-display">1.0</span></div>
                </div>

                <!-- Coins -->
                <div class="flex flex-col items-center min-w-[80px]">
                    <div class="text-[10px] text-yellow-500 uppercase tracking-widest font-bold">Coins</div>
                    <div class="text-2xl font-bold text-yellow-400 flex items-center gap-1">
                        <i data-lucide="coins" class="w-4 h-4"></i>
                        <span id="coins-display">0</span>
                    </div>
                </div>

                <button onclick="game.toggleSettings()" class="p-2 hover:bg-slate-700 rounded-full transition-colors">
                    <i data-lucide="settings" class="w-6 h-6 text-slate-400"></i>
                </button>
            </div>
        </div>

        <!-- MAIN GAME AREA -->
        <div class="flex-1 flex p-6 gap-6 min-h-0 relative z-10">
            
            <!-- LEFT: VISUALIZER -->
            <div class="flex-1 bg-slate-900 rounded-2xl border border-slate-700 flex flex-col overflow-hidden relative shadow-2xl">
                <!-- Enemy Header -->
                <div class="h-20 px-6 bg-slate-800 border-b border-slate-700 flex justify-between items-center shrink-0 relative overflow-hidden">
                    
                    <!-- Explosive Warning Background -->
                    <div id="boss-warning-bg" class="absolute inset-0 bg-rose-900/20 hidden animate-pulse"></div>

                    <div class="flex flex-col justify-center relative z-10">
                        <div class="flex items-center gap-2">
                            <div class="text-xs text-rose-400 font-bold uppercase tracking-widest">Enemy Function</div>
                            <span id="explosive-badge" class="hidden px-2 py-0.5 bg-rose-600 text-white text-[10px] font-bold rounded uppercase tracking-wider animate-pulse">Explosive</span>
                        </div>
                        <div id="function-display" class="text-3xl font-bold text-white font-serif italic tracking-wide mt-1">f(x) = ?</div>
                    </div>
                    
                    <div class="text-right w-1/3 relative z-10">
                        <div class="flex justify-between text-xs mb-1 font-bold">
                            <span class="text-slate-400">ENEMY HP</span>
                            <span id="hp-text" class="text-slate-200">100/100</span>
                        </div>
                        <div class="h-4 bg-slate-950 rounded-full overflow-hidden border border-slate-600 relative">
                            <div id="hp-bar" class="h-full bg-rose-500 transition-all duration-300" style="width: 100%"></div>
                        </div>
                    </div>
                </div>

                <!-- Canvas -->
                <div class="flex-1 relative bg-[#050505] cursor-move overflow-hidden group">
                    <canvas id="graph-canvas" class="block w-full h-full"></canvas>
                    
                    <!-- Antiderivative Hint -->
                    <div id="math-feedback" class="absolute top-4 right-4 text-right pointer-events-none transition-opacity duration-300 opacity-0">
                        <div class="bg-slate-900/90 backdrop-blur p-4 rounded-xl border border-slate-700 shadow-xl">
                            <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold mb-1">Antiderivative F(x)</div>
                            <div id="antideriv-display" class="text-2xl text-sky-400 font-serif italic">?</div>
                        </div>
                    </div>

                    <div class="absolute bottom-4 left-4 pointer-events-none text-xs text-slate-600 opacity-50 group-hover:opacity-100 transition-opacity">
                        Scroll to Zoom • Drag to Pan
                    </div>
                </div>
            </div>

            <!-- RIGHT: INTEGRATION CONSOLE -->
            <div class="w-[400px] flex flex-col gap-4">
                
                <!-- Deck Info (Hidden by User Request) -->
                <div class="flex justify-between items-center px-2" style="display: none;">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">Hand Size</div>
                    <div class="text-xs font-bold text-slate-300"><span id="hand-count">0</span> Cards</div>
                </div>

                <!-- Main Console -->
                <div class="bg-slate-800 rounded-2xl border border-slate-700 shadow-xl overflow-hidden flex flex-col relative">
                    <!-- Scanline overlay specific to console -->
                    <div class="absolute inset-0 bg-gradient-to-b from-transparent to-slate-900/50 pointer-events-none"></div>

                    <div class="p-3 bg-slate-700/50 border-b border-slate-700 text-center">
                        <h2 class="text-xs font-bold text-slate-300 uppercase tracking-[0.3em]">Integration Console</h2>
                    </div>
                    
                    <div class="p-6 flex flex-col items-center gap-4 bg-slate-800 relative z-10">
                        
                        <!-- Integral UI -->
                        <div class="flex items-center justify-center gap-6 w-full py-2">
                            <div class="text-slate-500 font-serif italic text-[6rem] leading-none select-none relative" style="top: -10px;">∫</div>
                            
                            <!-- Slots Container -->
                            <div class="flex flex-col justify-between h-28">
                                <!-- Upper Bound (b) -->
                                <div id="slot-b" class="slot w-16 h-12 bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg flex items-center justify-center text-xl font-bold text-white cursor-pointer hover:border-sky-400 transition-colors shadow-inner" data-slot="b">
                                    <span class="text-slate-600 text-xs pointer-events-none font-sans">b</span>
                                </div>
                                
                                <!-- Lower Bound (a) -->
                                <div id="slot-a" class="slot w-16 h-12 bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg flex items-center justify-center text-xl font-bold text-white cursor-pointer hover:border-sky-400 transition-colors shadow-inner" data-slot="a">
                                    <span class="text-slate-600 text-xs pointer-events-none font-sans">a</span>
                                </div>
                            </div>

                            <div class="text-2xl font-serif italic text-white/50">f(x) dx</div>
                        </div>

                        <!-- Preview Screen -->
                        <div class="w-full space-y-1">
                            <div class="flex justify-between items-end px-1">
                                <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Evaluation (FToC)</div>
                                <div class="text-[10px] text-emerald-400 font-bold tracking-wider opacity-0" id="hint-indicator">HINTS ACTIVE</div>
                            </div>
                            <div class="bg-slate-950 p-3 rounded-lg border border-slate-700 font-mono text-sm text-center shadow-[inset_0_2px_4px_rgba(0,0,0,0.5)]">
                                <div id="calculation-preview" class="text-lg text-white/90">
                                    ? - ? = <span class="text-slate-600">?</span>
                                </div>
                            </div>
                            <div id="validation-msg" class="text-[12px] text-rose-500 text-center h-4 font-bold tracking-wide"></div>
                        </div>

                        <!-- Action Button -->
                        <button id="btn-integrate" class="w-full py-3 bg-sky-600 hover:bg-sky-500 text-white font-bold text-xl tracking-widest rounded-lg shadow-[0_4px_0_rgb(12,74,110)] active:shadow-none active:translate-y-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:active:translate-y-0" disabled>
                            INTEGRATE
                        </button>
                    </div>
                </div>

                <!-- Message Log -->
                <div class="bg-slate-900 rounded-xl border-l-4 border-slate-600 p-4 min-h-[4.5rem] flex items-center justify-center text-center shadow-lg">
                    <div id="message-log" class="text-sm text-slate-400 font-medium">
                        Drag cards to start integrating.
                    </div>
                </div>

            </div>
        </div>

        <!-- BOTTOM: HAND -->
        <div class="h-44 bg-slate-900 border-t border-slate-700 relative z-20 flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
            <div class="text-[10px] text-slate-500 px-6 py-2 uppercase tracking-widest font-bold flex justify-between">
                <span>Your Deck</span>
                <span class="text-sky-500" id="tutorial-msg"></span>
            </div>
            <!-- Added pt-5 to fix card hover clipping -->
            <div class="flex-1 overflow-x-auto px-6 pt-5 pb-0 flex items-center gap-4" id="hand-container">
                <!-- Cards Injected Here -->
            </div>
        </div>

    </div>

    <!-- SCREENS & MODALS -->

    <!-- Tutorial Popup Modal -->
    <div id="tutorial-modal" class="hidden absolute bottom-48 left-1/2 transform -translate-x-1/2 z-50 w-[500px]">
        <div class="bg-slate-800/95 border border-sky-500/50 p-6 rounded-xl shadow-2xl backdrop-blur-md relative animate-[slideIn_0.3s_ease-out]">
            <div class="absolute -top-3 -left-3 bg-sky-500 text-white p-2 rounded-lg shadow-lg">
                <i data-lucide="info" class="w-6 h-6"></i>
            </div>
            <h3 class="text-sky-400 font-bold uppercase tracking-wider mb-2" id="tutorial-title">Tutorial</h3>
            <p class="text-slate-200 text-sm leading-relaxed mb-4" id="tutorial-body">...</p>
            <div class="text-right">
                <button onclick="document.getElementById('tutorial-modal').classList.add('hidden')" class="text-xs text-slate-500 hover:text-white uppercase font-bold tracking-widest">Dismiss</button>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="absolute inset-0 bg-slate-950 z-50 flex items-center justify-center">
        <div class="max-w-4xl w-full p-10 bg-slate-900 border border-slate-700 rounded-3xl shadow-2xl flex flex-col items-center relative overflow-hidden">
            <!-- Decorative BG -->
            <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj48ZyBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0wIDQwaDQwVjBIMHY0MHptMjAgMjBWMjBoMjB2MjBIMjB6IiBmaWxsPSIjMWUyOTNiIiBmaWxsLW9wYWNpdHk9IjAuMSIvPjwvZz48L3N2Zz4=')] opacity-20"></div>
            
            <h1 class="text-7xl font-bold text-sky-400 tracking-tighter mb-4 drop-shadow-2xl relative z-10">INTEGREAT!</h1>
            <p class="text-slate-400 text-xl mb-10 font-light relative z-10">The Calculus Roguelike</p>
            
            <div class="grid grid-cols-2 gap-8 text-left mb-10 w-full relative z-10">
                <div class="bg-slate-800/80 p-6 rounded-2xl border border-slate-700 backdrop-blur-sm">
                    <h3 class="text-sky-400 font-bold mb-3 flex items-center gap-2 text-lg"><i data-lucide="calculator" class="w-5 h-5"></i> Core Mechanics</h3>
                    <ul class="text-sm text-slate-300 space-y-2 list-disc pl-5 leading-relaxed">
                        <li>Calculate area: $\int_a^b f(x) dx$.</li>
                        <li><b>Damage = Area</b>.</li>
                        <li><b>Overkill Penalty:</b> Dealing extra damage reduces score! Formula: $1 + 2 \times \%_{extra}$.</li>
                        <li><b>Exact Kill:</b> Hit 0 HP exactly for a massive bonus!</li>
                    </ul>
                </div>
                <div class="bg-slate-800/80 p-6 rounded-2xl border border-slate-700 backdrop-blur-sm">
                    <h3 class="text-rose-400 font-bold mb-3 flex items-center gap-2 text-lg"><i data-lucide="bomb" class="w-5 h-5"></i> Danger Zones</h3>
                    <ul class="text-sm text-slate-300 space-y-2 list-disc pl-5 leading-relaxed">
                        <li><b>Explosive Bosses:</b> Appear every 3 rounds.</li>
                        <li><b>The Rule:</b> You MUST kill them exactly.</li>
                        <li><b>Failure:</b> Overkilling a Boss ends the run instantly.</li>
                        <li>Regular Explosives reset Round Score to 0.</li>
                    </ul>
                </div>
            </div>

            <div class="flex gap-6 relative z-10">
                <button onclick="game.startTutorial()" class="px-8 py-4 bg-slate-700 hover:bg-slate-600 text-white font-bold text-lg rounded-xl transition-all border border-slate-600 hover:border-slate-500">
                    PLAY TUTORIAL
                </button>
                <button onclick="game.startRun()" class="px-12 py-4 bg-sky-600 hover:bg-sky-500 text-white font-bold text-lg rounded-xl shadow-lg shadow-sky-900/50 transition-all hover:-translate-y-1">
                    START NEW RUN
                </button>
            </div>
            
            <div class="mt-8 text-xs text-slate-600 font-mono relative z-10">
                Made by Rohan Inampudi
            </div>
        </div>
    </div>

    <!-- SHOP / ROUND END SCREEN -->
    <div id="shop-screen" class="hidden absolute inset-0 bg-slate-950 z-40 flex items-center justify-center">
        <div class="max-w-2xl w-full p-8 bg-slate-900 border border-slate-700 rounded-3xl shadow-2xl text-center relative overflow-hidden">
             <!-- Decorative BG -->
            <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj48ZyBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0wIDQwaDQwVjBIMHY0MHptMjAgMjBWMjBoMjB2MjBIMjB6IiBmaWxsPSIjMWUyOTNiIiBmaWxsLW9wYWNpdHk9IjAuMSIvPjwvZz48L3N2Zz4=')] opacity-20"></div>

            <h2 class="text-4xl font-bold text-white mb-2 relative z-10">ROUND COMPLETE</h2>
            <div class="w-24 h-1 bg-sky-500 mx-auto mb-8 rounded-full relative z-10"></div>

            <div class="grid grid-cols-3 gap-4 mb-8 relative z-10">
                <div class="bg-slate-800 p-4 rounded-xl">
                    <div class="text-xs text-slate-400 uppercase tracking-widest">Base Score</div>
                    <div class="text-2xl font-bold text-white" id="shop-score">0</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl">
                    <div class="text-xs text-slate-400 uppercase tracking-widest">Card Mult</div>
                    <div class="text-2xl font-bold text-amber-400" id="shop-mult">x1.0</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-yellow-500/30 bg-yellow-900/10">
                    <div class="text-xs text-yellow-500 uppercase tracking-widest">Earnings</div>
                    <div class="text-3xl font-bold text-yellow-400 flex justify-center items-center gap-2">
                        <i data-lucide="coins" class="w-5 h-5"></i> <span id="shop-earnings">0</span>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 p-8 rounded-xl border border-dashed border-slate-700 mb-8 relative z-10">
                <i data-lucide="store" class="w-12 h-12 text-slate-600 mx-auto mb-2"></i>
                <h3 class="text-xl font-bold text-slate-500">Shop Coming Soon</h3>
                <p class="text-slate-600 text-sm">Spend your coins on upgrades in future updates.</p>
            </div>
            
            <div id="next-round-warning" class="mb-4 text-rose-400 font-bold uppercase tracking-widest animate-pulse hidden relative z-10">
                Warning: Explosive Boss Approaching
            </div>

            <button onclick="game.nextRound()" class="px-10 py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-xl rounded-xl shadow-lg transition-all transform hover:-translate-y-1 relative z-10">
                START NEXT ROUND
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden absolute inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="w-96 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl overflow-hidden">
            <div class="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-white font-bold">Settings</h2>
                <button onclick="game.toggleSettings()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Hints Toggle -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-white font-bold">Enable Hints</div>
                        <div class="text-xs text-slate-400 w-48">Show antiderivative and calculation preview.</div>
                    </div>
                    <button id="btn-hints" onclick="game.toggleHints()" class="w-12 h-6 rounded-full bg-slate-700 relative transition-colors">
                        <div id="hint-knob" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform"></div>
                    </button>
                </div>
                <div class="pt-4 border-t border-slate-800">
                     <button onclick="location.reload()" class="w-full py-2 bg-rose-900/50 hover:bg-rose-900 text-rose-200 text-sm font-bold rounded border border-rose-800 transition-colors">ABORT RUN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex items-center justify-center flex-col gap-6 backdrop-blur">
        <h1 class="text-7xl font-bold text-rose-500 mb-2 drop-shadow-[0_0_25px_rgba(244,63,94,0.6)] animate-pulse">GAME OVER</h1>
        
        <div class="bg-slate-900 p-8 rounded-2xl border border-slate-800 min-w-[350px] text-center shadow-2xl">
            <div id="death-reason" class="text-xl text-white font-bold mb-6 border-b border-slate-800 pb-4">Use Reason Here</div>
            
            <div class="grid grid-cols-2 gap-4 mb-2">
                <div>
                    <div class="text-xs text-slate-500 uppercase tracking-widest">Rounds</div>
                    <div id="final-round" class="text-2xl font-bold text-white">0</div>
                </div>
                <div>
                    <div class="text-xs text-slate-500 uppercase tracking-widest">Coins</div>
                    <div id="final-coins" class="text-2xl font-bold text-yellow-400">0</div>
                </div>
            </div>
        </div>
        <button onclick="location.reload()" class="px-10 py-4 bg-white text-slate-900 font-bold rounded-xl hover:bg-sky-400 hover:text-white transition-colors text-lg">TRY AGAIN</button>
    </div>

    <script>
        // Init Icons
        lucide.createIcons();

        // --- MATH ENGINE ---
        
        // Helper to convert float to fraction string (e.g. 0.333 -> 1/3)
        function floatToFraction(x) {
            const tolerance = 1.0E-6;
            let h1 = 1, h2 = 0, k1 = 0, k2 = 1;
            let b = x;
            do {
                let a = Math.floor(b);
                let aux = h1; h1 = a * h1 + h2; h2 = aux;
                aux = k1; k1 = a * k1 + k2; k2 = aux;
                b = 1 / (b - a);
            } while (Math.abs(x - h1 / k1) > x * tolerance);
            
            if (k1 === 1) return `${h1}`; // Integer
            return `${h1}/${k1}`;
        }

        class Term {
            constructor(coeff, power) { this.coeff = coeff; this.power = power; }
            integrate() { return new Term(this.coeff / (this.power + 1), this.power + 1); }
            evaluate(x) { return this.coeff * Math.pow(x, this.power); }
            toHTML() {
                if (this.coeff === 0) return "";
                if (this.power === 0) return floatToFraction(this.coeff); // Use fraction display
                
                let cStr = this.coeff === 1 ? "" : (this.coeff === -1 ? "-" : floatToFraction(this.coeff));
                if (this.power === 1) return `${cStr}x`;
                return `${cStr}x<sup>${this.power}</sup>`;
            }
        }

        class Polynomial {
            constructor(terms) { this.terms = terms; }
            integrate() { return new Polynomial(this.terms.map(t => t.integrate())); }
            evaluate(x) { return this.terms.reduce((sum, t) => sum + t.evaluate(x), 0); }
            toDisplay() {
                if (this.terms.length === 0) return "0";
                return this.terms.map(t => t.toHTML()).join(" + ").replace(/\+ -/g, "- ");
            }
        }

        // --- LEVEL GENERATION ---
        class LevelGenerator {
            static generate(round, isBoss) {
                // Difficulty Scaling
                // Round 1-2: Linear
                // Round 3-5: Quadratic
                // Round 6+: Cubic
                
                const difficulty = isBoss ? round + 2 : round;
                let terms = [];
                
                if (difficulty <= 2) {
                    // Linear: mx + b
                    terms.push(new Term(1 + Math.floor(Math.random()*3), 1));
                    if(Math.random() > 0.5) terms.push(new Term(1 + Math.floor(Math.random()*5), 0));
                } else if (difficulty <= 5) {
                    // Quadratic
                    terms.push(new Term(1 + Math.floor(Math.random()*2), 2));
                    terms.push(new Term(Math.floor(Math.random()*4), 0));
                } else {
                    // Cubic
                    terms.push(new Term(1 + Math.floor(Math.random()*2), 3));
                    terms.push(new Term(Math.floor(Math.random()*3), 1));
                }

                const func = new Polynomial(terms);
                const anti = func.integrate();

                // Puzzle Generation:
                // If it is Explosive (Boss or Regular), we MUST ensure an exact solution is possible with the given hand.
                // To keep this simple, we will make it so every level is perfectly solvable.
                // We pick 2-4 pairs of (a, b) that will constitute the HP.
                
                const isExplosive = isBoss || (Math.random() < 0.15 && round > 1);
                
                let targetHP = 0;
                let requiredCards = [];
                const numPairs = isBoss ? 2 + Math.floor(Math.random() * 2) : 2 + Math.floor(Math.random() * 2);

                for(let i=0; i<numPairs; i++) {
                    const a = Math.floor(Math.random() * 5); // 0-4
                    const b = a + 1 + Math.floor(Math.random() * 3); // a+1 to a+3
                    const dmg = anti.evaluate(b) - anti.evaluate(a);
                    
                    if(dmg > 0.1) {
                        targetHP += dmg;
                        requiredCards.push(a, b);
                    }
                }

                // Add Junk
                const junkCount = isBoss ? 2 : 4;
                for(let i=0; i<junkCount; i++) requiredCards.push(Math.floor(Math.random() * 8));
                
                requiredCards.sort(() => Math.random() - 0.5);

                return {
                    terms: terms,
                    hp: Math.floor(targetHP), 
                    hand: requiredCards,
                    isExplosive: isExplosive,
                    isBoss: isBoss
                };
            }
        }

        // --- GAME LOGIC ---

        class Game {
            constructor() {
                // State
                this.mode = 'menu'; // menu, tutorial, run
                this.round = 1;
                this.levelInRound = 1;
                this.levelsPerRound = 5;
                
                this.totalScore = 0; // Cumulative score for records
                this.roundScore = 0; // Current round score for mechanics
                this.coins = 0;
                this.mult = 1.0;
                
                this.hand = [];
                this.currentFunction = null; 
                this.currentAntideriv = null; 
                this.enemyHP = 0;
                this.maxHP = 0;
                this.isExplosive = false;
                this.isBoss = false;

                // Tutorial State
                this.tutorialStep = 0;

                // UI
                this.slotA = null;
                this.slotB = null;
                this.hintsEnabled = false;

                // Rendering
                this.canvas = document.getElementById('graph-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.pan = { x: 0, y: 0, zoom: 1 };
                this.isDraggingGraph = false;
                this.lastMousePos = { x: 0, y: 0 };
                
                // Init
                this.resizeGame();
                window.addEventListener('resize', () => this.resizeGame());
                this.bindInputs();
            }

            resizeGame() {
                const scaler = document.getElementById('app-scaler');
                const scale = Math.min(window.innerWidth / 1280, window.innerHeight / 800);
                scaler.style.transform = `scale(${scale})`;
                if(this.currentFunction) this.renderGraph();
            }

            bindInputs() {
                document.getElementById('btn-integrate').addEventListener('click', () => this.performIntegration());
                this.setupDragDrop();
                
                // Graph Inputs
                this.canvas.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    this.pan.zoom *= Math.exp(-e.deltaY * 0.001);
                    this.pan.zoom = Math.max(0.1, Math.min(this.pan.zoom, 5));
                    this.renderGraph();
                });
                this.canvas.addEventListener('mousedown', (e) => {
                    this.isDraggingGraph = true;
                    this.lastMousePos = { x: e.clientX, y: e.clientY };
                });
                window.addEventListener('mousemove', (e) => {
                    if (!this.isDraggingGraph) return;
                    const scale = parseFloat(document.getElementById('app-scaler').style.transform.replace('scale(', '')) || 1;
                    this.pan.x += (e.clientX - this.lastMousePos.x) / scale;
                    this.pan.y += (e.clientY - this.lastMousePos.y) / scale;
                    this.lastMousePos = { x: e.clientX, y: e.clientY };
                    this.renderGraph();
                });
                window.addEventListener('mouseup', () => this.isDraggingGraph = false);
            }

            // --- FLOW ---

            startTutorial() {
                this.mode = 'tutorial';
                this.round = 1;
                this.coins = 0;
                this.roundScore = 0;
                this.totalScore = 0;
                this.tutorialStep = 1;
                document.getElementById('start-screen').classList.add('hidden');
                
                // Tutorial Step 1: Basic Integration
                this.loadData({
                    terms: [new Term(2, 0)], // f(x) = 2
                    hp: 10,
                    hand: [0, 5, 2, 3, 4],
                    isExplosive: false,
                    isBoss: false
                });
                this.showTutorialPopup("Basics", "Welcome! The goal is to defeat the Enemy Function by calculating area.<br><br><b>Drag '0' to 'a' and '5' to 'b'</b> to calculate $\\int_0^5 2 dx$.");
                this.showTutorialMsg("Tutorial: Basic Integration");
                this.drawLoop();
            }

            advanceTutorial() {
                this.tutorialStep++;
                
                if (this.tutorialStep === 2) {
                    // Tutorial Step 2: Score & Penalties
                    this.loadData({
                        terms: [new Term(1, 1)], // f(x) = x
                        hp: 12, // int_0^4 x dx = 8. int_0^6 = 18.
                        hand: [0, 4, 0, 6],
                        isExplosive: false,
                        isBoss: false
                    });
                    this.showTutorialPopup("Scoring Rules", "Every card you use increases your <b>Multiplier</b>. But be careful!<br><br><b>Overkill Penalty:</b> If you deal more damage than HP, you lose score! The penalty is <b>Amplified</b> ($1 + 2\\times\\%_{excess}$) based on how much you miss by.<br><br>Try hitting exactly 12 HP, or get close!");
                }
                else if (this.tutorialStep === 3) {
                    // Step 3: Round End & Shop
                    this.endRound(); // Show shop
                    this.showTutorialPopup("Round Complete", "At the end of a round, your <b>Round Score</b> is multiplied by your <b>Card Mult</b> and converted into <b>Coins</b>.<br><br>Your Round Score resets to 0, but you keep your Coins!");
                }
                else if (this.tutorialStep === 4) {
                    // Step 4: Boss
                    this.round = 3; // Simulate boss round
                    const bossData = LevelGenerator.generate(3, true); // Force boss
                    this.loadData(bossData);
                    document.getElementById('shop-screen').classList.add('hidden');
                    this.showTutorialPopup("BOSS BATTLE", "This is an <b>Explosive Boss</b>.<br><br>You <b>MUST</b> hit 0 HP exactly. If you overkill an Explosive Boss, the run ends immediately.<br><br>Calculate carefully!");
                    this.showTutorialMsg("Tutorial: Explosive Boss");
                }
                else if (this.tutorialStep === 5) {
                    // Step 5: Finish
                    this.showTutorialPopup("Tutorial Complete", "You survived! You are now ready for the real challenge.<br><br>Good luck!");
                    setTimeout(() => {
                        this.showTutorialMsg("");
                        document.getElementById('start-screen').classList.remove('hidden');
                    }, 4000);
                }
            }

            startRun() {
                this.mode = 'run';
                this.round = 1;
                this.coins = 0;
                this.totalScore = 0;
                this.startRound();
                document.getElementById('start-screen').classList.add('hidden');
                this.drawLoop();
            }

            startRound() {
                this.roundScore = 0; // Reset Score for the round
                this.mult = 1.0;
                this.levelInRound = 1;
                this.levelsPerRound = 5 + Math.floor(Math.random() * 4); // 5-8 levels
                
                this.updateGlobalUI();
                this.nextLevel();
            }

            nextLevel() {
                if (this.levelInRound > this.levelsPerRound) {
                    this.endRound();
                    return;
                }

                // Is Boss? Boss rounds are every 3 rounds (3, 6, 9...)
                // Boss round has ONLY 1 level.
                const isBossRound = (this.round % 3 === 0);
                if (isBossRound) {
                    // If it is a boss round, overwrite levelsPerRound to 1 so we only do 1 level
                    this.levelsPerRound = 1;
                }

                const data = LevelGenerator.generate(this.round, isBossRound);
                this.loadData(data);
            }

            loadData(data) {
                this.currentFunction = new Polynomial(data.terms);
                this.currentAntideriv = this.currentFunction.integrate();
                this.maxHP = data.hp;
                this.enemyHP = data.hp;
                this.isExplosive = data.isExplosive;
                this.isBoss = data.isBoss;
                this.hand = data.hand.map(v => ({ id: Math.random().toString(36), value: v }));

                // UI Reset
                this.slotA = null; this.slotB = null;
                this.updateSlotUI();
                this.pan = { x: 0, y: 0, zoom: 1 };
                
                // Display Update
                document.getElementById('function-display').innerHTML = `f(x) = ${this.currentFunction.toDisplay()}`;
                document.getElementById('antideriv-display').innerHTML = this.currentAntideriv.toDisplay();
                
                // Visuals
                const badge = document.getElementById('explosive-badge');
                const warning = document.getElementById('boss-warning-bg');
                if (this.isExplosive) {
                    badge.classList.remove('hidden');
                    warning.classList.remove('hidden');
                    document.getElementById('function-display').classList.add('text-rose-200');
                } else {
                    badge.classList.add('hidden');
                    warning.classList.add('hidden');
                    document.getElementById('function-display').classList.remove('text-rose-200');
                }

                this.updateGlobalUI();
                this.updateHPUI();
                this.renderHand();
                this.renderGraph();
            }

            endRound() {
                if (this.mode === 'tutorial' && this.tutorialStep !== 3) {
                    // Tutorial logic handled in advanceTutorial except for step 3
                    return;
                }

                // Calculate Coins
                const earned = Math.floor(this.roundScore * this.mult / 100);
                this.coins += earned;
                
                document.getElementById('shop-score').innerText = this.roundScore;
                document.getElementById('shop-mult').innerText = `x${this.mult.toFixed(1)}`;
                document.getElementById('shop-earnings').innerText = earned;
                
                // Warn about next round
                const nextIsBoss = ((this.round + 1) % 3 === 0);
                const warningEl = document.getElementById('next-round-warning');
                if (nextIsBoss) {
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }

                document.getElementById('shop-screen').classList.remove('hidden');
            }

            nextRound() {
                if (this.mode === 'tutorial') {
                    this.advanceTutorial();
                    return;
                }
                this.round++;
                document.getElementById('shop-screen').classList.add('hidden');
                this.startRound();
            }

            // --- INTERACTIONS ---

            setupDragDrop() {
                ['slot-a', 'slot-b'].forEach(id => {
                    const slot = document.getElementById(id);
                    slot.addEventListener('dragover', e => { e.preventDefault(); slot.classList.add('drag-over'); });
                    slot.addEventListener('dragleave', () => slot.classList.remove('drag-over'));
                    slot.addEventListener('drop', e => {
                        e.preventDefault();
                        slot.classList.remove('drag-over');
                        this.fillSlot(slot.dataset.slot, JSON.parse(e.dataTransfer.getData('text/plain')));
                    });
                    slot.addEventListener('click', () => {
                        if (id === 'slot-a' && this.slotA) { this.hand.push(this.slotA); this.slotA = null; }
                        if (id === 'slot-b' && this.slotB) { this.hand.push(this.slotB); this.slotB = null; }
                        this.updateSlotUI();
                        this.renderHand();
                    });
                });
            }

            fillSlot(type, card) {
                if (type === 'a') { if(this.slotA) this.hand.push(this.slotA); this.slotA = card; }
                if (type === 'b') { if(this.slotB) this.hand.push(this.slotB); this.slotB = card; }
                this.hand = this.hand.filter(c => c.id !== card.id);
                this.updateSlotUI();
                this.renderHand();
            }

            updateSlotUI() {
                const map = { a: this.slotA, b: this.slotB };
                ['a', 'b'].forEach(k => {
                    const el = document.getElementById(`slot-${k}`);
                    if (map[k]) {
                        el.innerHTML = `<span class="text-3xl text-sky-400 font-bold pointer-events-none">${map[k].value}</span>`;
                        el.classList.add('bg-sky-900', 'border-sky-400');
                    } else {
                        el.innerHTML = `<span class="text-slate-600 text-xs pointer-events-none font-sans">${k}</span>`;
                        el.classList.remove('bg-sky-900', 'border-sky-400');
                    }
                });
                this.updatePreview();
            }

            updatePreview() {
                const btn = document.getElementById('btn-integrate');
                const preview = document.getElementById('calculation-preview');
                const validMsg = document.getElementById('validation-msg');
                
                validMsg.innerText = '';

                if (this.slotA && this.slotB) {
                    const a = parseInt(this.slotA.value);
                    const b = parseInt(this.slotB.value);
                    
                    if (a >= b) {
                        btn.disabled = true;
                        validMsg.innerText = a === b ? "Zero Width (a = b)" : `Invalid: a (${a}) > b (${b})`;
                        preview.innerHTML = `<span class="text-rose-500 font-bold">INVALID BOUNDS</span>`;
                    } else {
                        btn.disabled = false;
                        const Fa = this.currentAntideriv.evaluate(a);
                        const Fb = this.currentAntideriv.evaluate(b);
                        const res = Fb - Fa;
                        
                        if (this.hintsEnabled) {
                            preview.innerHTML = `<span class="text-sky-400">${Fb.toFixed(1)}</span> - <span class="text-purple-400">${Fa.toFixed(1)}</span> = <span class="text-white font-bold">${res.toFixed(1)}</span>`;
                        } else {
                            preview.innerHTML = `F(${b}) - F(${a}) = <span class="text-white font-bold">?</span>`;
                        }
                    }
                } else {
                    btn.disabled = true;
                    preview.innerHTML = `? - ? = <span class="text-slate-600">?</span>`;
                }
            }

            performIntegration() {
                if (!this.slotA || !this.slotB) return;
                
                // Logic
                const a = parseInt(this.slotA.value);
                const b = parseInt(this.slotB.value);
                const damage = this.currentAntideriv.evaluate(b) - this.currentAntideriv.evaluate(a);
                const intDamage = Math.floor(damage); // Damage is usually integer due to coef choices, but safe floor

                // Consume Cards (don't return to hand)
                this.slotA = null; this.slotB = null;
                this.updateSlotUI();
                
                // Increase Mult
                this.mult += 0.2; // +0.1 per card used (2 cards)

                // Check Overkill
                const remaining = this.enemyHP;
                const overkill = damage - remaining;
                
                let scoreChange = 0;
                let logMsg = "";

                if (overkill > 0.01) {
                    // Overkill Logic
                    if (this.isExplosive) {
                        if (this.isBoss) {
                            this.triggerGameOver("EXPLOSIVE BOSS TRIGGERED");
                            return;
                        } else {
                            // Regular Explosive Penalty
                            this.roundScore = 0;
                            logMsg = `<span class="text-rose-500 font-bold">EXPLOSION! Round Score Reset!</span>`;
                            this.shakeScreen();
                        }
                    } else {
                        // Normal Overkill Penalty: Amplified
                        // Formula: penaltyMult = 1 + (pct * 2) (More forgiving than *5)
                        const pct = overkill / remaining; 
                        const penaltyMult = 1 + (pct * 2); 
                        const deduction = Math.ceil(overkill * penaltyMult * 5); // Base scale 5
                        scoreChange = -deduction;
                        logMsg = `<span class="text-amber-500 font-bold">OVERKILL!</span> Score <span class="text-rose-500">-${deduction}</span>`;
                        this.shakeScreen();
                    }
                } else if (Math.abs(overkill) < 0.01) {
                    // Perfect Kill
                    const bonus = Math.floor(this.maxHP * 0.5);
                    scoreChange = intDamage + bonus;
                    logMsg = `<span class="text-emerald-400 font-bold">PERFECT KILL!</span> +${scoreChange}`;
                } else {
                    // Normal Hit
                    scoreChange = intDamage;
                    logMsg = `<span class="text-sky-400 font-bold">HIT!</span> ${damage.toFixed(1)} Damage`;
                }

                this.enemyHP -= damage;

                // Update Score (Prevent negative total round score if desired, or allow it. Usually min 0 is safer)
                if (!this.isExplosive || overkill <= 0.01) {
                    this.roundScore += Math.floor(scoreChange);
                    if (this.roundScore < 0) this.roundScore = 0; // Prevent debt
                    
                    if (scoreChange > 0) this.totalScore += Math.floor(scoreChange);
                }

                // VFX
                const particle = document.createElement('div');
                particle.className = 'particle text-6xl font-bold fixed z-50 drop-shadow-lg';
                particle.style.left = '50%'; particle.style.top = '40%';
                particle.innerText = scoreChange > 0 ? `+${scoreChange}` : `${scoreChange}`;
                particle.classList.add(scoreChange > 0 ? 'text-emerald-400' : 'text-rose-500');
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1500);

                document.getElementById('message-log').innerHTML = logMsg;
                this.updateGlobalUI();
                this.updateHPUI();

                // Check Level End
                if (this.enemyHP <= 0.01) {
                    if (this.mode === 'tutorial') {
                        setTimeout(() => this.advanceTutorial(), 1500);
                    } else {
                        setTimeout(() => {
                            this.levelInRound++;
                            this.nextLevel();
                        }, 1200);
                    }
                } else {
                    if (this.hand.length < 2) {
                        this.triggerGameOver("Ran out of cards");
                    }
                }
            }

            // --- UI HELPERS ---

            updateGlobalUI() {
                // Display Round Score instead of Total Score
                document.getElementById('score-display').innerText = this.roundScore;
                document.getElementById('coins-display').innerText = this.coins;
                document.getElementById('mult-display').innerText = this.mult.toFixed(1);
                document.getElementById('round-display').innerText = this.round;
                document.getElementById('level-display').innerText = `${this.levelInRound}/${this.levelsPerRound}`;
                document.getElementById('hand-count').innerText = this.hand.length;
            }

            updateHPUI() {
                const pct = Math.max(0, (this.enemyHP / this.maxHP) * 100);
                document.getElementById('hp-bar').style.width = `${pct}%`;
                document.getElementById('hp-text').innerText = `${Math.ceil(Math.max(0, this.enemyHP))}/${this.maxHP}`;
            }

            renderHand() {
                const c = document.getElementById('hand-container');
                c.innerHTML = '';
                this.hand.forEach(card => {
                    const el = document.createElement('div');
                    el.className = 'card shrink-0 w-20 h-28 bg-slate-100 rounded-lg shadow-lg flex flex-col items-center justify-center cursor-grab border-2 border-slate-300 relative';
                    el.draggable = true;
                    el.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', JSON.stringify(card)); el.classList.add('dragging'); });
                    el.addEventListener('dragend', () => el.classList.remove('dragging'));
                    el.innerHTML = `<div class="text-xs text-slate-400 font-bold absolute top-1 left-2">${card.value}</div><div class="text-4xl font-bold text-slate-800">${card.value}</div><div class="text-xs text-slate-400 font-bold absolute bottom-1 right-2">${card.value}</div>`;
                    c.appendChild(el);
                });
            }

            showTutorialPopup(title, body) {
                const modal = document.getElementById('tutorial-modal');
                document.getElementById('tutorial-title').innerText = title;
                document.getElementById('tutorial-body').innerHTML = body;
                modal.classList.remove('hidden');
            }

            toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
            toggleHints() { 
                this.hintsEnabled = !this.hintsEnabled; 
                document.getElementById('btn-hints').classList.toggle('bg-emerald-500'); 
                document.getElementById('hint-knob').classList.toggle('translate-x-6');
                document.getElementById('math-feedback').style.opacity = this.hintsEnabled ? 1 : 0;
                document.getElementById('hint-indicator').style.opacity = this.hintsEnabled ? 1 : 0;
                this.updatePreview();
            }

            triggerGameOver(reason) {
                document.getElementById('game-over-screen').classList.remove('hidden');
                document.getElementById('death-reason').innerText = reason;
                document.getElementById('final-round').innerText = this.round;
                document.getElementById('final-coins').innerText = this.coins;
            }

            shakeScreen() {
                const app = document.getElementById('app-scaler');
                app.classList.remove('shake');
                void app.offsetWidth;
                app.classList.add('shake');
            }

            showTutorialMsg(msg) {
                const el = document.getElementById('tutorial-msg');
                el.innerText = msg;
                el.classList.add('animate-pulse');
            }

            // --- GRAPH RENDER ---
            renderGraph() {
                const w = this.canvas.width = this.canvas.clientWidth;
                const h = this.canvas.height = this.canvas.clientHeight;
                const ctx = this.ctx;

                ctx.clearRect(0, 0, w, h);

                // Camera Logic
                const scaleX = (w / 20) * this.pan.zoom; 
                const scaleY = scaleX; 
                const originX = w / 2 + this.pan.x;
                const originY = h / 2 + this.pan.y;

                // Grid
                ctx.strokeStyle = "#1e293b";
                ctx.lineWidth = 1;

                function calculateStep(graphZoom, baseStep = 1, sensitivity) {
                    if (baseStep / graphZoom <= 1) return 1 
                    let unroundedStep = Math.max(1, Math.floor((1.5 * baseStep) / graphZoom));
                    return roundToNiceNumber(unroundedStep);
                }

                function roundToNiceNumber(value) {
                    // Get the magnitude (power of 10) of the number
                    const magnitude = Math.floor(Math.log10(value));
                    const powerOf10 = Math.pow(10, magnitude);
                    // Normalize the value to a number between 1 and 10
                    const normalizedValue = value / powerOf10;
                    // Determine the nice fractional value (1, 2, or 5)
                    let niceFractional;
                    if (normalizedValue >= 5) {
                        niceFractional = 5;
                    } else if (normalizedValue >= 2) {
                        niceFractional = 2;
                    } else {
                        niceFractional = 1;
                    }
                    return niceFractional * powerOf10;
                }
                
                // Vertical Lines (X-axis)
                const xStep =  calculateStep(this.pan.zoom, 1);
                const numLinesX = Math.ceil((w / (scaleX * xStep)) / 2) * 2 + 1;
                const startX =  Math.ceil(0-numLinesX - this.pan.x / (scaleX * xStep));
                const endX = Math.floor(numLinesX - this.pan.x / (scaleX * xStep));
                for(let i=startX; i<endX; i++) {
                    const val = i * xStep;
                    const x = originX + val * scaleX;
                    if(x < 0 || x > w) continue;
                    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
                    if (i === 0) continue;
                    ctx.fillStyle = "#64748b"; ctx.font = "12px monospace"; ctx.fillText(val, x - 4, originY + 20);
                }
                
                // Horizontal Lines (Y-Axis)
                const yStep = calculateStep(this.pan.zoom, 1);
                const numLinesY = Math.ceil((h / (scaleY * yStep)) / 2) * 2 + 1;
                const startY =  Math.ceil(0-numLinesY + this.pan.y / (scaleY * yStep));
                const endY = Math.floor(numLinesY + this.pan.y / (scaleY * yStep));
                for(let i=startY; i<endY; i++) {
                    const val = i * yStep;
                    const y = originY - val * scaleY;
                    if(y < 0 || y > h) continue;
                    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
                    if(i === 0) continue;
                    ctx.fillStyle = "#64748b"; ctx.font = "12px monospace"; ctx.fillText(val, originX - (8 + 6 * val.toString().length), y + 4);
                }

                // Draw Axes
                ctx.strokeStyle = "#94a3b8";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(originX, 0); ctx.lineTo(originX, h); // Y Axis
                ctx.moveTo(0, originY); ctx.lineTo(w, originY); // X Axis
                ctx.stroke();

                // Draw Function
                ctx.beginPath();
                ctx.strokeStyle = this.isExplosive ? "#fb7185" : "#38bdf8"; 
                ctx.lineWidth = 4;
                
                let startDraw = false;
                for(let px = 0; px < w; px+=2) { // Step optimization
                    const mathX = (px - originX) / scaleX;
                    const mathY = this.currentFunction.evaluate(mathX);
                    const py = originY - (mathY * scaleY);

                    // Clamp large values to prevent canvas rendering bugs
                    if (py < -1000 || py > h + 1000) {
                        startDraw = false;
                        continue;
                    }

                    if (!startDraw) {
                        ctx.moveTo(px, py);
                        startDraw = true;
                    } else {
                        ctx.lineTo(px, py);
                    }
                }
                ctx.stroke();

                // Draw Active Area
                if (this.slotA !== null && this.slotB !== null) {
                    const a = parseInt(this.slotA.value);
                    const b = parseInt(this.slotB.value);
                    
                    if (a < b) {
                        const startX = originX + a * scaleX;
                        const endX = originX + b * scaleX;

                        const grad = ctx.createLinearGradient(0, 0, 0, h);
                        grad.addColorStop(0, this.isExplosive ? "rgba(244, 63, 94, 0.5)" : "rgba(56, 189, 248, 0.5)"); 
                        grad.addColorStop(1, "rgba(244, 63, 94, 0.1)");

                        ctx.fillStyle = grad;
                        ctx.beginPath();
                        ctx.moveTo(startX, originY);

                        for(let px = startX; px <= endX; px++) {
                            const mathX = (px - originX) / scaleX;
                            const mathY = this.currentFunction.evaluate(mathX);
                            const py = originY - (mathY * scaleY);
                            ctx.lineTo(px, py);
                        }

                        ctx.lineTo(endX, originY);
                        ctx.closePath();
                        ctx.fill();

                        ctx.strokeStyle = this.isExplosive ? "#fb7185" : "#38bdf8";
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(startX, originY); ctx.lineTo(startX, originY - this.currentFunction.evaluate(a)*scaleY);
                        ctx.moveTo(endX, originY); ctx.lineTo(endX, originY - this.currentFunction.evaluate(b)*scaleY);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                }
            }

            drawLoop() {
                if(!this.isDraggingGraph) { // Only auto-render if not dragging to save perf
                    this.renderGraph(); 
                }
                requestAnimationFrame(() => this.drawLoop());
            }
        }

        const game = new Game();
    </script>
</body>
</html>